
Nodejs RESTful API Basic
=============================================================

:Date: 5 Oct 2019

What is the idea?
-----------------------

- In the previous parts we use **Socket.io + WebSocket** to handle communication between nodejs server and client
- In this part we make an alternative: **RESTful API**

Backend Server 
-------------------

- **index.js**

.. code-block:: javascript

	var app = require('express')()
	var jsonParser = require('body-parser').json()

	app.get('/', (req, res) =>{
	    res.sendFile(__dirname+'/index.html');
	})

	app.post('/', jsonParser, function (req, res) {
	    console.log(req.body);
	    res.send("You sent: "+JSON.stringify(req.body));
	})

	var port = 3000;
	app.listen(port, () => console.log(`http://localhost:${port}`))

Frontend Client
------------------

- **index.html**

.. code-block:: html

	<div id="demo"></div>
	<script>
		var xhttp = new XMLHttpRequest();
	  	xhttp.onreadystatechange = function() {
		    if (this.readyState == 4 && this.status == 200) {
		      	document.getElementById("demo").innerHTML = this.responseText;
		    }
	  	};

	  	xhttp.open("POST", "http://localhost:3000", true);
	  	xhttp.setRequestHeader("Content-type", "application/json");
	  
	  	var object = {key:"value"};
	  	xhttp.send(JSON.stringify(object));
	</script>

Username/Password Authentication
------------------------------------

- The following is from `here <https://stackoverflow.com/questions/14572600/passport-js-restful-auth>`_

Let's look at how plain old authentication works first.

- The user connects to https://example.com
- The server serves a rich Javascript application which renders the initial page. Somehwere in the page there is a login form.
- Many of the sections of this single page app haven't been populated with data due to the user not being logged in. All these sections have an event listener on a "login" event. All this is client side stuff, the server does not know of these events.
- User enters his/her login and password and hits the submit button, which triggers a Javascript handler to record the username and password in client side variables. Then this handler triggers the "login" event. Again, this is all client side action, credentials were not sent to the server yet.
- The listeners of the "login" event are invoked. Each of these now needs to send one or more requests to the RESTful API at https://example.com/api to obtain the user specific data to render on the page. Every single request they send to the web service will include the username and password, possibly in the form of HTTP Basic authentication, since the service being RESTful isn't allowed to maintain client state from one request to the next. Since the web service is on secure HTTP the password is safely encrypted during transit.
- The web service at https://example.com/api receives a bunch of individual requests, each with authentication information. The username and password in each request is checked against the user database and if found correct the requested function executes and data is returned to the client in JSON format. If username and password do not match an error is sent to the client in the form of a 401 HTTP error code.
- Instead of forcing clients to send username and password with every request you can have a "get_access_token" function in your RESTful service that takes the username and password and responds with a token, which is some sort of cryptographic hash that is unique and has some expiration date associated with it. These tokens are stored in the database with each user. Then the client sends the access token in subsequent requests. The access token will then be validated against the database instead of the username and password.
- Non browser client applications like phone apps do the same as above, they ask user to enter his/her credentials, then send them (or an access token generated from them) with every request to the web service.
- The important take away point from this example is that RESTful web services require authentication with every request.

Facebook authentication
------------------------------------

- The following is from `here <https://stackoverflow.com/questions/14572600/passport-js-restful-auth>`_

The workflow above does not work for Facebook connect because the login via Facebook has a third party, Facebook itself. The login procedure requires the user to be redirected to Facebook's website where credentials are entered outside of our control.

So let's see how things change:.

- The user connects to https://example.com
- The server serves a rich Javascript application which renders the initial page. Somehwere in the page there is a login form that includes a "Login with Facebook" button.
- The user clicks the "Login with Facebook" button, which is just a link that redirects to (for example) https://example.com/auth/facebook.
- The https://example.com/auth/facebook route is handled by passport.js (see the documentation)
- All the user sees is that the page changes and now they are in a Facebook hosted page where they need to login and authorize our web application. This is completely outside of our control.
- The user logs in to Facebook and gives permission to our application, so Facebook now redirects back to the callback URL that we configured in the passport.js setup, which following the example in the documentation is https://example.com/auth/facebook/callback
- The passport.js handler for the https://example.com/auth/facebook/callback route will invoke the callback function that receives the Facebook access token and some user information from Facebook, including the user's email address.
- With the email we can locate the user in our database and store the Facebook access token with it.
- The last thing you do in the Facebook callback is to redirect back to the rich client application, but this time we need to pass the username and the access token to the client so that it can use them. This can be done in a number of ways. For example, Javascript variables can be added to the page through a server-side template engine, or else a cookie can be returned with this information. (thanks to @RyanKimber for pointing out the security issues with passing this data in the URL, as I initially suggested).
- So now we start the single page app one more time, but the client has the username and the access token.
- The client application can trigger the "login" event immediately and let the different parts of the application request the information that they need from the web service.
- All the requests sent to https://example.com/api will include the Facebook access token for authentication, or the application's own access token generated from Facebook's token via a "get_access_token" function in the REST API.
- The non-browser apps have it a bit more difficult here, because OAuth requires a web browser for logging in. To login from a phone or desktop app you will need to start a browser to do the redirect to Facebook, and even worse, you need a way for the browser to pass the Facebook access token back to the application via some mechanism.
