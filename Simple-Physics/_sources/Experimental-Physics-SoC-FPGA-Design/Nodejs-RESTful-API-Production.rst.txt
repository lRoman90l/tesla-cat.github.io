
Nodejs RESTful API Production
=============================================================

:Date: 5 Oct 2019

Backend Module
------------------

- **my_modules/SimpleAPI.js**
- **To Be Completed: sqlite**
- **Dependencies**
	- **express**	// Of course
	- **./SimpleGmail.js**  // To send verification email
	- **crypto**   // To generate secretCode for verification
	- **ejs**	// To use html templates
	- **mongoose (MongoDB)**   // Database

.. code-block:: javascript

	module.exports = class SimpleAPI{
	    constructor(hostIP, port, app, appName, myAddress, myPassword){
	        var self = this
	        self.appName = appName
	        // express server
	        const jsonParser = require('body-parser').json()

	        app.get('/SimpleAPI/setAccountVerify',(req, res)=>{
	            //self.verifyEmail(req)
	            console.log(req.query)
	            res.send("Account has been set!")
	        })
	        app.post('/SimpleAPI',jsonParser,(req,res)=>{
	            if(req.body.type == "setAccount"){
	                self.setAccount(req)
	            }
	            else{
	                error = self.verifyUser(req)
	                if(error) res.send(JSON.stringify(error))
	                else self.serve(req,res)
	            }
	        })
	        self.host = "http://"+hostIP+":"+port
	        app.listen(port, hostIP, () => console.log(self.host))        
	        
	        // mongodb mongoose
	        self.mongoose = require('mongoose')
	        self.mongoose.connect('mongodb://localhost/SimpleAPI',{useNewUrlParser: true})
	        self.db = self.mongoose.connection
	        self.db.on('error',console.error.bind(console,'db err:'))
	        self.defineSchemasAndModels()
	        self.db.once('open',()=>{self.test()})

	        // SimpleGmail
	        const SimpleGmail = require("./SimpleGmail.js")
	        self.simpleGmail = new SimpleGmail(myAddress, myPassword)
	    }

	    setAccount(req,res){
	        var self = this
	        var secretCode = require('crypto').randomBytes(48)
	        
	        // register secretCode in database
	        var state = "ToBeVerified"+secretCode

	        // send user email for verification
	        var receiverAddress = req.body.setAccount.receiverAddress
	        var subject = self.appName+": Set Account Verification"
	                
	        var htmlPromise = require('ejs').renderFile(__dirname+'/SetAccountVerification.ejs',{
	            subject: subject, 
	            host: self.host, 
	            receiverAddress: receiverAddress, 
	            password: req.body.setAccount.password, 
	            state: state
	        });

	        htmlPromise.then(html =>{
	            console.log(html)
	            self.simpleGmail.send(receiverAddress, subject, html)
	        })         
	    }

	    verifyEmail(req){
	        // check if secretCode in req matches with one in database
	    }    

	    verifyUser(req){

	    }

	    serve(req,res){

	    }

	    defineSchemasAndModels(){
	        var self = this
	        var KittySchema = new self.mongoose.Schema({name:String})
	        KittySchema.methods.speak=function(){
	            console.log(this.name)
	        }
	        self.KittyModel = self.mongoose.model('KittyModel', KittySchema)
	    }

	    test(){
	        var self = this
	        var fluffy = new self.KittyModel({name:'fluffy'})
	        fluffy.save((err, fluffy)=>{
	            if (err) return console.error(err)
	            fluffy.speak()
	        })
	        self.KittyModel.find((err,kittens)=>{
	            console.log(kittens)
	        })
	    }
	}


Backend Main
------------------

- **index.js**

.. code-block:: javascript

	const app = require('express')()
	app.get('/',(req, res)=>{
	    res.sendFile(__dirname+'/index.html')
	})

	const SimpleAPI = require("./my_modules/SimpleAPI.js")
	const simpleAPI = new SimpleAPI(
	    hostIP = 'localhost',
	    port = 3000,
	    app,
	    appName = "SimpleAPI",
	    myAddress = "dingruiqi97m@gmail.com", 
	    myPassword = "ThisIsRealPassword"
	)

Backend Email Verification Template
--------------------------------------

- **my_modules/SetAccountVerification.ejs**

.. code-block:: html

	  <h><%= subject %></h>

	  <p>receiverAddress: <%= receiverAddress %></p>
	  <p>password: <%= password %></p>
	  <p>state: <%= state %></p>

	  <button><a href="
	    <%= host+'/SimpleAPI/setAccountVerify?'
	                  +'receiverAddress='+receiverAddress
	                  +'&password='+password
	                  +'&state='+state
	    %>" class="button">Confirm
	  </a></button>

Frontend For Testing
--------------------------------------

- **index.html**

.. code-block:: html

	Hello!
	<div id="demo"></div>
	<script>
	  var xhttp = new XMLHttpRequest();
	  xhttp.onreadystatechange = function() {
	    if (this.readyState == 4 && this.status == 200) {
	      document.getElementById("demo").innerHTML = this.responseText;
	    }
	  };
	  xhttp.open("POST", "http://localhost:3000/SimpleAPI", true);
	  xhttp.setRequestHeader("Content-type", "application/json");
	  
	  var reqbody={
	    type:"setAccount",
	    setAccount: ["416640656@qq.com","password","data"]
	  };
	  xhttp.send(JSON.stringify(reqbody));
	</script>