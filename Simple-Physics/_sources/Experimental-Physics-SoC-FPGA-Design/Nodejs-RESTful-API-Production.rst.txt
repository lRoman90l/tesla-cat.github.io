
Nodejs RESTful API Production
=============================================================

:Date: 5 Oct 2019

Backend Main
------------------

- To use:

.. code-block:: console

	sudo service mongod start
	node index.js

- **index.js**

.. code-block:: javascript

	const app = require('express')()
	app.get('/',(req, res)=>{
	    res.sendFile(__dirname+'/index.html')
	})

	const SimpleAPI = require("./my_modules/SimpleAPI.js")
	const simpleAPI = new SimpleAPI(
	    hostIP = 'localhost',
	    port = 3000,
	    app,
	    appName = "SimpleAPI",
	    myAddress = "dingruiqi97m@gmail.com", 
	    myPassword = "bomb4065"
	)

Backend Module
------------------

- **my_modules/SimpleAPI.js**
- **To Be Completed: sqlite**
- **Dependencies**
	- **express**	// Of course
	- **./SimpleGmail.js**  // To send verification email
	- **crypto**   // To generate secretCode for verification
	- **ejs**	// To use html templates
	- **mongoose (MongoDB)**   // Database

.. code-block:: javascript

	module.exports = class SimpleAPI{
	    constructor(hostIP, port, app, appName, myAddress, myPassword){
	        var self = this
	        self.appName = appName
	        // express server
	        const jsonParser = require('body-parser').json()

	        app.get('/SimpleAPI/setAccountVerify',(req, res)=>{
	            //self.verifyEmail(req)
	            console.log(req.query)
	            res.send("Account has been set!")
	        })
	        app.post('/SimpleAPI',jsonParser,(req,res)=>{
	            if(req.body.type == "setAccount"){
	                self.setAccount(req,res)
	            }
	            else{
	                error = self.verifyUser(req)
	                if(error) res.send(JSON.stringify(error))
	                else self.serve(req,res)
	            }
	        })
	        self.host = "http://"+hostIP+":"+port
	        app.listen(port, hostIP, () => console.log(self.host))        
	        
	        // mongodb mongoose
	        self.mongoose = require('mongoose')
	        self.mongoose.connect('mongodb://localhost/SimpleAPI',{useNewUrlParser: true})
	        self.db = self.mongoose.connection
	        self.db.on('error',console.error.bind(console,'db err:'))
	        self.defineSchemasAndModels()
	        self.db.once('open',()=>{self.test()})

	        // SimpleGmail
	        const SimpleGmail = require("./SimpleGmail.js")
	        self.simpleGmail = new SimpleGmail(myAddress, myPassword)
	    }

	    setAccount(req,res){
	        var self = this
	        var secretCode = require('crypto').randomBytes(48)
	        
	        // register secretCode in database
	        req.body.setAccount.state = "ToBeVerified"+secretCode
	        var account = new self.AccountModel(req.body.setAccount)

	        // send user email for verification
	        var email = req.body.setAccount.email
	        var subject = self.appName+": Set Account Verification"
	                
	        var htmlPromise = require('ejs').renderFile(__dirname+'/SetAccountVerification.ejs',{
	            subject: subject, 
	            host: self.host, 
	            setAccount: req.body.setAccount
	        });

	        htmlPromise.then( (html)=>{
	            self.simpleGmail.send(email, subject, html)
	            res.send(html)
	        })         
	    }

	    verifyEmail(req){
	        // check if secretCode in req matches with one in database
	    }    

	    verifyUser(req){

	    }

	    serve(req,res){

	    }

	    defineSchemasAndModels(){
	        var self = this
	        var AccountSchema = new self.mongoose.Schema({
	            // for security
	            type: String,
	            email: String,
	            password: String,
	            state: String,
	            // for search
	            city: String,
	            gender: String,
	            occupation: String,
	            labels: [String],
	            // for display
	            display: String
	        })
	        self.AccountModel = self.mongoose.model('AccountModel', AccountSchema)
	    
	        var OrderSchema = new self.mongoose.Schema({
	            // for security
	            buyerEmail: String,
	            sellerEmail: String,
	            states: [String],
	            // for search
	            productName: String,
	            buyFrom: String,
	            priceRange: [Number],
	            dateRange: [Date],
	            mailingAddress: String,
	            bountyRatio: Number,
	            // for display
	            display: String
	        })
	        self.OrderModel = self.mongoose.model('OrderModel', OrderSchema)
	    }

	    test(){
	        var self = this
	        var account = new self.AccountModel({email:'test'})
	        account.save()
	        self.AccountModel.find((err,accounts)=>{
	            console.log(accounts)
	        })
	    }
	}


Backend Email Verification Template
--------------------------------------

- **my_modules/SetAccountVerification.ejs**

.. code-block:: html

	<h><%= subject %></h>

	<p>setAccount: <%= JSON.stringify(setAccount) %></p>

	<button>
	    <a href="
	        <%= host+'/SimpleAPI/setAccountVerify?'
	            +'type='        + setAccount.type
	            +'&email='      + setAccount.email
	            +'&password='   + setAccount.password
	            +'&state='      + setAccount.state
	        %>"
	    >Confirm</a>
	</button>

Frontend For Testing
--------------------------------------

- **index.html**

.. code-block:: html

	<h>Hello!</h>

	<h3>setAccount verification email will look like this:</h3>
	<div id="setAccount"></div>

	<script>

	  var xhttp = new XMLHttpRequest();
	  xhttp.onreadystatechange = function() {
	    if (this.readyState == 4 && this.status == 200) {
	      document.getElementById("setAccount").innerHTML = this.responseText;
	    }
	  };
	  xhttp.open("POST", "http://localhost:3000/SimpleAPI", true);
	  xhttp.setRequestHeader("Content-type", "application/json");
	  
	  var reqbody={
	    type:"setAccount",
	    setAccount: {
	      type: "buyer",
	      email: "416640656@qq.com",
	      password: "qwerty",
	    }
	  };
	  xhttp.send(JSON.stringify(reqbody));

	</script>